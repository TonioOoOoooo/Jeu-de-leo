<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L'Aventure de L√©o - Final</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #fffdf0;
            overflow: hidden;
            font-family: 'Patrick Hand', 'Comic Sans MS', cursive, sans-serif;
            touch-action: none;
            user-select: none;
        }
        canvas {
            display: block;
            margin: 0 auto;
            cursor: pointer;
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }
        #hud {
            padding: 20px;
            font-size: 40px;
            color: #e74c3c;
            text-shadow: 2px 2px 0 #333;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        #key-display {
            font-size: 30px;
            color: gold;
            text-shadow: 2px 2px 0 #000;
            display: none; /* Cach√© au d√©but */
        }
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            pointer-events: auto;
            text-align: center;
        }
        .big-btn {
            background: #27ae60;
            color: white;
            border: 4px solid #333;
            padding: 20px 40px;
            font-size: 30px;
            font-family: inherit;
            cursor: pointer;
            border-radius: 20px;
            box-shadow: 5px 5px 0px #333;
            margin-top: 30px;
        }
        .big-btn:active { transform: translate(2px, 2px); box-shadow: 3px 3px 0px #333; }
        
        #controls {
            pointer-events: auto;
            display: flex;
            justify-content: space-between;
            padding: 20px;
            padding-bottom: 40px;
        }
        .d-pad { display: flex; gap: 20px; }
        .btn {
            background: rgba(255, 255, 255, 0.9);
            border: 4px solid #333;
            border-radius: 20px;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #333;
            font-weight: bold;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.2);
        }
        .btn:active { background: #eee; transform: translateY(4px); box-shadow: 1px 1px 0 rgba(0,0,0,0.2); }

        #message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border: 6px solid #333;
            border-radius: 25px;
            text-align: center;
            display: none;
            pointer-events: auto;
            box-shadow: 15px 15px 0px rgba(0,0,0,0.1);
            z-index: 30;
            min-width: 320px;
        }
        
        .space-hint {
            font-size: 18px; color: #666; margin-top: 10px;
        }

        @media (min-width: 768px) {
            #controls { display: none; }
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-size: 60px; margin: 0; color:#d35400;">L'Aventure de L√©o</h1>
        <p style="font-size: 28px;">Mission : Trouve la CL√â pour sortir !</p>
        <button class="big-btn" onclick="startGame()">JOUER ‚ñ∂</button>
    </div>

    <div id="ui-layer">
        <div id="hud">
            <span id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
            <span id="key-display">üóùÔ∏è CL√â OK !</span>
        </div>
        
        <div id="message-box">
            <h2 id="msg-title" style="font-size:50px; margin:0;">Bravo !</h2>
            <p id="msg-text" style="font-size:28px;">...</p>
            <button class="big-btn" onclick="resetGame()">Recommencer</button>
            <p class="space-hint">(Appuie sur ESPACE pour rejouer)</p>
        </div>

        <div id="controls">
            <div class="d-pad">
                <div class="btn" id="btn-left">‚Üê</div>
                <div class="btn" id="btn-right">‚Üí</div>
            </div>
            <div class="d-pad">
                <div class="btn" id="btn-down">‚Üì</div>
                <div class="btn" id="btn-up">‚Üë</div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let gameRunning = false;
        let animationId;
        let lives = 3;
        let hasKey = false;
        let invincibilityTimer = 0;
        let keyItem = null; // L'objet cl√©

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if(gameRunning) initLevel(); 
        }
        window.addEventListener('resize', resize);
        resize();

        const keys = { right: false, left: false, up: false, down: false };

        const player = {
            x: 50, y: 50, w: 40, h: 50,
            vx: 0, vy: 0,
            speed: 6,
            jumpForce: 13,
            grounded: false,
            climbing: false,
            jumpCount: 0,
            color: '#3498db'
        };

        const gravity = 0.8;
        const friction = 0.8;
        
        let platforms = [];
        let hazards = [];
        let enemies = [];
        let ladders = []; 
        let goal = {};

        function createSlide(startX, startY, width, height, steps) {
            // Cr√©er un escalier descendant pour simuler la pente physiquement
            let stepW = width / steps;
            let stepH = height / steps;
            
            for(let i=0; i<steps; i++) {
                platforms.push({
                    x: startX + (i * stepW),
                    y: startY + (i * stepH),
                    w: stepW + 2, // +2 pour √©viter les trous
                    h: stepH + 40, // Assez √©pais pour ne pas passer au travers
                    type: 'slide',
                    isStep: true // Marqueur pour le dessin (on ne dessine pas les marches)
                });
            }
            
            // On ajoute un objet "visuel" pour dessiner la pente lisse par dessus
            platforms.push({
                x: startX, y: startY, w: width, h: height,
                type: 'slide_visual'
            });
        }

        function initLevel() {
            const w = canvas.width;
            const h = canvas.height;
            const unit = h > 100 ? h / 10 : 60;

            player.vx = 0; player.vy = 0;
            player.climbing = false; player.jumpCount = 0;
            hasKey = false;
            
            platforms = []; hazards = []; enemies = []; ladders = [];

            // 1. D√âPART
            platforms.push({ x: -100, y: unit * 2, w: 600, h: unit }); 
            player.x = 50; player.y = (unit * 2) - player.h; player.grounded = true;

            // 2. PI√àGES (Espac√©s)
            let trapX = 550; let trapY = unit * 3;
            platforms.push({ x: trapX, y: trapY, w: unit * 4, h: unit });
            hazards.push({ x: trapX + 30, y: trapY - 25, w: 25, h: 25, type: 'spike' });
            hazards.push({ x: trapX + 130, y: trapY - 25, w: 25, h: 25, type: 'spike' });

            // 3. VRAI TOBOGGAN (En pente !)
            let slideX = trapX + unit * 4;
            let slideY = unit * 3; // Part du niveau des pi√®ges
            // Descend de 2 unit√©s de hauteur sur 4 unit√©s de longueur
            createSlide(slideX, slideY, unit * 4, unit * 2, 8); 

            // 4. ZOMBIE (En bas du toboggan)
            let zombiePlatX = slideX + unit * 4;
            let zombiePlatY = unit * 5;
            platforms.push({ x: zombiePlatX, y: zombiePlatY, w: unit * 8, h: unit });
            
            enemies.push({
                x: zombiePlatX + 200, y: zombiePlatY - 60, w: 50, h: 60,
                type: 'zombie', patrolStart: zombiePlatX + 50, patrolEnd: zombiePlatX + unit * 7, dir: 1
            });

            // 5. √âCHELLE
            let ladderX = zombiePlatX + unit * 7;
            let floorY = h - unit * 1.5;
            ladders.push({ x: ladderX, y: zombiePlatY, w: 60, h: floorY - zombiePlatY });

            // 6. SOL DU BAS
            platforms.push({ x: ladderX - 500, y: floorY, w: w + 800, h: unit * 2 });

            // 7. MONSTRE COFFRE (Garde la cl√© √† gauche)
            enemies.push({
                x: ladderX - 200, y: floorY - 60, w: 60, h: 60,
                type: 'chest_monster', patrolStart: ladderX - 350, patrolEnd: ladderX - 100, dir: 1
            });

            // 8. LA CL√â (Tout √† gauche, derri√®re le monstre)
            keyItem = { x: ladderX - 400, y: floorY - 50, w: 40, h: 40 };

            // 9. PORTAIL FIN (Tout √† droite)
            goal = { x: ladderX + 300, y: floorY - 80, w: 70, h: 80 };
            
            // S√âCURIT√â
            hazards.push({ x: -1000, y: h + 100, w: w * 10, h: 100, type: 'void' });
        }

        function update() {
            if (!gameRunning) return;
            if (invincibilityTimer > 0) invincibilityTimer--;
            let prevY = player.y;

            // Ennemis
            for(let e of enemies) {
                if (e.patrolEnd) {
                    e.x += e.dir * 2;
                    if(e.x > e.patrolEnd) { e.x = e.patrolEnd; e.dir = -1; }
                    if(e.x < e.patrolStart) { e.x = e.patrolStart; e.dir = 1; }
                }
            }

            // Cl√©
            if (!hasKey && keyItem) {
                if (player.x < keyItem.x + keyItem.w && player.x + player.w > keyItem.x &&
                    player.y < keyItem.y + keyItem.h && player.y + player.h > keyItem.y) {
                    hasKey = true;
                    keyItem = null;
                    document.getElementById('key-display').style.display = "inline";
                }
            }

            // Echelles
            let touchingLadder = false;
            let currentLadder = null;
            for(let l of ladders) {
                if (player.x + player.w > l.x && player.x < l.x + l.w &&
                    player.y + player.h > l.y - 10 && player.y < l.y + l.h + 20) {
                    touchingLadder = true; currentLadder = l;
                }
            }
            if (touchingLadder && (keys.up || keys.down)) {
                player.climbing = true; player.jumpCount = 0; 
            }
            if (!touchingLadder) player.climbing = false;

            // Mouvement
            if (player.climbing) {
                player.vy = 0; player.vx = 0;
                if(keys.up) player.y -= 4;
                if(keys.down) player.y += 4;
                if(keys.left) player.x -= 2;
                if(keys.right) player.x += 2;
                if (currentLadder && player.y + player.h > currentLadder.y + currentLadder.h) {
                    player.y = (currentLadder.y + currentLadder.h) - player.h;
                }
            } else {
                if (keys.right) player.vx += 1;
                if (keys.left) player.vx -= 1;
                player.vx *= friction;
                if(player.vx > player.speed) player.vx = player.speed;
                if(player.vx < -player.speed) player.vx = -player.speed;
                player.x += player.vx;
                player.vy += gravity;
                if(player.vy > 15) player.vy = 15; 
                player.y += player.vy;
            }

            // Collisions
            player.grounded = false;
            if (!player.climbing || keys.up) { 
                for (let p of platforms) {
                    if (p.type === 'slide_visual') continue; // On ignore l'objet visuel pour la physique

                    if (player.x + player.w > p.x + 5 && player.x < p.x + p.w - 5) {
                        let feetNow = player.y + player.h;
                        let feetBefore = prevY + player.h;
                        
                        if (player.vy >= 0 && feetBefore <= p.y + 15 && feetNow >= p.y) {
                            player.y = p.y - player.h;
                            player.vy = 0;
                            player.grounded = true;
                            player.jumpCount = 0; 
                            if (p.type === 'slide') player.vx += 5; // √áa glisse !
                        }
                    }
                }
            }
            if(player.x < 0) { player.x = 0; player.vx = 0; }
            checkInteractions();
        }

        function updateHud() {
            let hearts = "";
            for(let i=0; i<lives; i++) hearts += "‚ù§Ô∏è";
            document.getElementById('hearts').innerText = hearts;
        }

        function checkInteractions() {
            const hit = (a, b) => {
                return a.x < b.x + b.w && a.x + a.w > b.x &&
                       a.y < b.y + b.h && a.y + a.h > b.y;
            };

            // Porte Finale
            if (hit(player, goal)) {
                if (hasKey) {
                    gameWin();
                } else {
                    // Repousse le joueur doucement et affiche message
                    if (player.x < goal.x) player.x -= 10;
                    ctx.fillStyle = "black";
                    ctx.font = "bold 20px 'Patrick Hand'";
                    // (Le message sera dessin√© dans draw())
                }
                return;
            }

            if (invincibilityTimer === 0) {
                let hurt = false;
                for(let h of hazards) if (hit(player, h)) {
                    if(h.type === 'void') { hurt = true; player.x=50; player.y=0; player.vy=0; } else hurt = true;
                }
                for(let e of enemies) if (hit(player, e)) hurt = true;

                if (hurt) {
                    lives--; updateHud();
                    if (lives <= 0) gameOver("Oh non ! Tu n'as plus de vies.");
                    else { player.vy = -10; player.vx = -player.vx * 1.5; invincibilityTimer = 60; }
                }
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Fond
            ctx.fillStyle = "#fffdf0"; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.strokeStyle = "rgba(100, 180, 255, 0.3)"; ctx.lineWidth = 1; ctx.beginPath();
            for(let y=0; y<canvas.height; y+=30) { ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); } ctx.stroke();
            ctx.strokeStyle = "rgba(255, 100, 100, 0.4)"; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(40, 0); ctx.lineTo(40, canvas.height); ctx.stroke();

            let camX = Math.min(0, (canvas.width * 0.3) - player.x);
            ctx.save(); ctx.translate(camX, 0);

            // Echelles
            for(let l of ladders) {
                ctx.strokeStyle = "#795548"; ctx.lineWidth = 4; ctx.beginPath();
                ctx.moveTo(l.x, l.y); ctx.lineTo(l.x, l.y+l.h);
                ctx.moveTo(l.x+l.w, l.y); ctx.lineTo(l.x+l.w, l.y+l.h);
                for(let i=0; i<l.h; i+=30) { ctx.moveTo(l.x, l.y+i); ctx.lineTo(l.x+l.w, l.y+i); } ctx.stroke();
            }

            // Plateformes
            for(let p of platforms) {
                if (p.isStep) continue; // On ne dessine pas les marches physiques invisibles

                if(p.type === 'slide_visual') {
                    // DESSIN DU TOBOGGAN EN PENTE LISSE
                    ctx.fillStyle = "rgba(241, 196, 15, 0.8)";
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y); // Haut Gauche
                    ctx.lineTo(p.x + p.w, p.y + p.h); // Bas Droite
                    ctx.lineTo(p.x, p.y + p.h); // Bas Gauche
                    ctx.fill();
                    
                    ctx.strokeStyle = "orange"; ctx.lineWidth = 5; ctx.beginPath();
                    ctx.moveTo(p.x, p.y); ctx.lineTo(p.x + p.w, p.y + p.h); ctx.stroke();
                } else {
                    ctx.fillStyle = "#2c3e50"; ctx.fillRect(p.x, p.y, p.w, p.h);
                    ctx.strokeStyle = "#27ae60"; ctx.lineWidth = 4; ctx.beginPath();
                    ctx.moveTo(p.x, p.y); for(let i=0; i<p.w; i+=10) ctx.lineTo(p.x+i+5, p.y - 5); ctx.stroke();
                }
            }

            // La Cl√© (si pas ramass√©e)
            if (!hasKey && keyItem) {
                ctx.fillStyle = "gold";
                ctx.beginPath(); ctx.arc(keyItem.x+15, keyItem.y+10, 10, 0, Math.PI*2); ctx.fill();
                ctx.fillRect(keyItem.x+12, keyItem.y+10, 6, 25);
                ctx.fillRect(keyItem.x+12, keyItem.y+25, 12, 5);
                ctx.fillRect(keyItem.x+12, keyItem.y+32, 10, 5);
                
                // Petit effet brillant
                if (Math.floor(Date.now() / 200) % 2 === 0) {
                    ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(keyItem.x+10, keyItem.y+5, 3, 0, Math.PI*2); ctx.fill();
                }
            }

            // Pi√®ges
            for(let h of hazards) if(h.type === 'spike') {
                ctx.fillStyle = "#c0392b"; ctx.beginPath(); ctx.moveTo(h.x, h.y+h.h); ctx.lineTo(h.x+h.w/2, h.y); ctx.lineTo(h.x+h.w, h.y+h.h); ctx.fill();
            }

            // Ennemis
            for(let e of enemies) {
                if(e.type === 'zombie') {
                    ctx.fillStyle = "#2ecc71"; ctx.fillRect(e.x, e.y, e.w, e.h);
                    ctx.fillRect(e.x-5, e.y-20, e.w+10, 30);
                    ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(e.x+12, e.y-5, 8, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(e.x+32, e.y-5, 6, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(e.x+12, e.y-5, 2, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(e.x+32, e.y-5, 2, 0, Math.PI*2); ctx.fill();
                    ctx.font = "bold 20px 'Patrick Hand'"; ctx.fillText("RE RE RE !", e.x - 10, e.y - 30);
                }
                else if(e.type === 'chest_monster') {
                    ctx.fillStyle = "#8d6e63"; ctx.fillRect(e.x, e.y, e.w, e.h);
                    ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.strokeRect(e.x, e.y, e.w, e.h);
                    ctx.fillStyle = "white"; ctx.beginPath(); ctx.moveTo(e.x, e.y+20);
                    for(let i=0; i<e.w; i+=10) { ctx.lineTo(e.x+i+5, e.y+30); ctx.lineTo(e.x+i+10, e.y+20); } ctx.fill();
                    ctx.strokeStyle = "#e74c3c"; ctx.lineWidth = 3; ctx.beginPath();
                    let tx = e.x + e.w + 10, ty = e.y + e.h;
                    ctx.moveTo(tx, ty); ctx.lineTo(tx, ty-50); ctx.moveTo(tx-10, ty-50); ctx.lineTo(tx+10, ty-50);
                    ctx.moveTo(tx-10, ty-50); ctx.lineTo(tx-10, ty-65); ctx.moveTo(tx, ty-50); ctx.lineTo(tx, ty-70);
                    ctx.moveTo(tx+10, ty-50); ctx.lineTo(tx+10, ty-65); ctx.stroke();
                }
            }

            // Portail
            ctx.fillStyle = "#f1c40f"; ctx.fillRect(goal.x, goal.y, goal.w, goal.h);
            ctx.strokeStyle = "black"; ctx.lineWidth = 3; ctx.strokeRect(goal.x, goal.y, goal.w, goal.h);
            ctx.fillStyle = "black"; ctx.fillText("NIV 2", goal.x + 10, goal.y - 10);
            ctx.beginPath(); ctx.arc(goal.x+goal.w-10, goal.y+goal.h/2, 4, 0, Math.PI*2); ctx.fill();
            
            if (!hasKey) {
                // Cadenas sur la porte
                ctx.fillStyle = "red";
                ctx.fillRect(goal.x + 20, goal.y + 30, 30, 30);
                ctx.fillStyle = "white";
                ctx.font = "30px sans-serif";
                ctx.fillText("üîí", goal.x + 20, goal.y + 55);
                
                // Message si joueur proche
                if (Math.abs(player.x - goal.x) < 100) {
                     ctx.fillStyle = "red";
                     ctx.font = "bold 24px 'Patrick Hand'";
                     ctx.fillText("IL FAUT LA CL√â !", goal.x - 50, goal.y - 40);
                }
            }

            // Joueur
            if(invincibilityTimer % 10 < 5) {
                ctx.fillStyle = player.color; ctx.beginPath();
                ctx.ellipse(player.x + player.w/2, player.y + player.h/2, player.w/2, player.h/2, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(player.x+10, player.y+15, 6, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(player.x+25, player.y+15, 6, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(player.x+12, player.y+15, 2, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(player.x+27, player.y+15, 2, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(player.x+player.w/2, player.y+30, 8, 0, Math.PI, false); ctx.stroke();
            }

            ctx.restore();
        }

        function handleKey(e, state) {
            if(['ArrowRight','d'].includes(e.key)) keys.right = state;
            if(['ArrowLeft','a'].includes(e.key)) keys.left = state;
            if(['ArrowUp','w',' '].includes(e.key)) keys.up = state;
            if(['ArrowDown','s'].includes(e.key)) keys.down = state;
            
            if(state && (e.key === 'ArrowUp' || e.key === ' ')) {
                if (player.grounded || player.climbing) {
                    player.vy = -player.jumpForce; player.grounded = false; player.climbing = false; player.jumpCount = 1; 
                } else if (player.jumpCount < 2) {
                    player.vy = -player.jumpForce; player.jumpCount++; 
                }
            }
            if (state && e.code === 'Space' && !gameRunning && document.getElementById('message-box').style.display === 'block') {
                resetGame();
            }
        }
        window.addEventListener('keydown', e => { handleKey(e, true); });
        window.addEventListener('keyup', e => handleKey(e, false));

        const bindTouch = (id, k) => {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', e => { e.preventDefault(); keys[k] = true; });
            el.addEventListener('touchend', e => { e.preventDefault(); keys[k] = false; });
            el.addEventListener('mousedown', e => { keys[k] = true; });
            el.addEventListener('mouseup', e => { keys[k] = false; });
        }
        bindTouch('btn-left', 'left'); bindTouch('btn-right', 'right'); bindTouch('btn-up', 'up'); bindTouch('btn-down', 'down');
        
        document.getElementById('btn-up').addEventListener('touchstart', () => {
             if (player.grounded || player.climbing) {
                 player.vy = -player.jumpForce; player.grounded = false; player.climbing = false; player.jumpCount = 1;
             } else if (player.jumpCount < 2) {
                 player.vy = -player.jumpForce; player.jumpCount++;
             }
        });

        function loop() { if(gameRunning) { update(); draw(); animationId = requestAnimationFrame(loop); } }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            lives = 3; updateHud();
            document.getElementById('key-display').style.display = 'none'; // Reset cl√© UI
            gameRunning = true; initLevel(); loop();
        }

        function gameOver(msg) {
            gameRunning = false;
            document.getElementById('msg-title').innerText = "Oh non !";
            document.getElementById('msg-title').style.color = "red";
            document.getElementById('msg-text').innerText = msg;
            document.getElementById('message-box').style.display = "block";
        }

        function gameWin() {
            gameRunning = false;
            document.getElementById('msg-title').innerText = "VICTOIRE !";
            document.getElementById('msg-title').style.color = "green";
            document.getElementById('msg-text').innerText = "Tu as trouv√© la cl√© et le coffre !";
            document.getElementById('message-box').style.display = "block";
        }

        function resetGame() {
            document.getElementById('message-box').style.display = "none";
            startGame();
        }

    </script>
</body>
</html>