<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L'Aventure de L√©o - Final</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap'); /* Police Pixel pour le niveau 5 */

        body {
            margin: 0;
            padding: 0;
            background-color: #fffdf0;
            overflow: hidden;
            font-family: 'Patrick Hand', 'Comic Sans MS', cursive, sans-serif;
            touch-action: none;
            user-select: none;
        }
        canvas {
            display: block;
            margin: 0 auto;
            cursor: pointer;
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }
        #hud {
            padding: 20px;
            font-size: 30px;
            color: #e74c3c;
            text-shadow: 2px 2px 0 #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            box-sizing: border-box;
        }
        #level-display {
            font-size: 40px; color: #333; font-weight: bold;
        }
        #key-display {
            font-size: 30px;
            color: gold;
            text-shadow: 2px 2px 0 #000;
            display: none; 
        }
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            pointer-events: auto;
            text-align: center;
        }
        .difficulty-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        .big-btn {
            color: white;
            border: 4px solid #333;
            padding: 15px 30px;
            font-size: 24px;
            font-family: inherit;
            cursor: pointer;
            border-radius: 20px;
            box-shadow: 5px 5px 0px #333;
            transition: transform 0.1s;
        }
        .btn-easy { background: #27ae60; }
        .btn-medium { background: #f39c12; }
        .btn-hard { background: #c0392b; }
        
        .big-btn:active { transform: translate(2px, 2px); box-shadow: 3px 3px 0px #333; }
        
        #controls {
            pointer-events: auto;
            display: flex;
            justify-content: space-between;
            align-items: flex-end; 
            padding: 20px;
            padding-bottom: 60px; 
            width: 100%;
            box-sizing: border-box;
        }
        
        .d-pad { display: flex; gap: 30px; }
        .d-pad-right { display: flex; flex-direction: column; gap: 20px; align-items: center; }

        .btn {
            background: rgba(255, 255, 255, 0.5);
            border: 3px solid rgba(51, 51, 51, 0.5);
            border-radius: 50%;
            width: 90px; height: 90px;
            display: flex; align-items: center; justify-content: center;
            font-size: 50px; color: #333; font-weight: bold;
            box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.1s;
        }
        .btn:active { background: rgba(255, 255, 255, 0.8); transform: scale(0.95); }
        #btn-up { width: 110px; height: 110px; background: rgba(46, 204, 113, 0.5); font-size: 60px; border-color: rgba(39, 174, 96, 0.8); }

        #message-box {
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 40px; border: 6px solid #333; border-radius: 25px;
            text-align: center; display: none; pointer-events: auto;
            box-shadow: 15px 15px 0px rgba(0,0,0,0.1); z-index: 30; min-width: 320px;
        }
        .space-hint { font-size: 18px; color: #666; margin-top: 10px; }

        @media (min-width: 768px) { #controls { display: none; } }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-size: 60px; margin: 0; color:#d35400;">L'Aventure de L√©o</h1>
        <p style="font-size: 28px;">Choisis ta difficult√© :</p>
        
        <div class="difficulty-container">
            <button class="big-btn btn-easy" onclick="startGame('easy')">FACILE üòä</button>
            <button class="big-btn btn-medium" onclick="startGame('medium')">MOYEN üòê</button>
            <button class="big-btn btn-hard" onclick="startGame('hard')">DUR üòà</button>
        </div>
        
        <p style="margin-top:30px; color:#888; font-size:16px;">
            (Clavier : A/Z pour bouger, Espace pour sauter)<br>
            (1, 2, 3, 4, 5 pour choisir niveau | + pour vies)
        </p>
    </div>

    <div id="ui-layer">
        <div id="hud">
            <span id="level-display">NIVEAU 1</span>
            <span id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
            <span id="key-display">üóùÔ∏è CL√â OK !</span>
        </div>
        
        <div id="message-box">
            <h2 id="msg-title" style="font-size:50px; margin:0;">Bravo !</h2>
            <p id="msg-text" style="font-size:28px;">...</p>
            <button class="big-btn btn-easy" id="msg-btn" onclick="nextLevelAction()">Continuer</button>
            <p class="space-hint" id="msg-hint">(ESPACE pour continuer)</p>
        </div>

        <div id="controls">
            <div class="d-pad">
                <div class="btn" id="btn-left">‚Üê</div>
                <div class="btn" id="btn-right">‚Üí</div>
            </div>
            <div class="d-pad-right">
                <div class="btn" id="btn-up">‚Üë</div>
                <div class="btn" id="btn-down">‚Üì</div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- IMAGES ---
        const zombieImg = new Image(); zombieImg.src = 'zombie.png'; 
        let zombieLoaded = false; zombieImg.onload = () => { zombieLoaded = true; };

        const tridentImg = new Image(); tridentImg.src = 'trident.png';
        let tridentLoaded = false; tridentImg.onload = () => { tridentLoaded = true; };

        // --- ETAT DU JEU ---
        let gameRunning = false;
        let currentLevel = 1;
        let animationId;
        let lives = 3;
        let hasKey = false;
        let invincibilityTimer = 0;
        let keyItem = null;
        let frameTick = 0;
        let levelComplete = false;
        let difficultyMultiplier = 1; 
        
        // --- TEMPS & VITESSE FIXE ---
        let lastTime = 0;
        let accumulator = 0;
        const TIME_STEP = 1000 / 60; 

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if(gameRunning && !levelComplete) initLevel(currentLevel); 
        }
        window.addEventListener('resize', resize);
        resize();

        const keys = { right: false, left: false, up: false, down: false };

        const player = {
            x: 50, y: 50, w: 40, h: 50,
            vx: 0, vy: 0,
            baseSpeed: 7, 
            speed: 7, 
            jumpForce: 13,
            grounded: false,
            climbing: false,
            jumpCount: 0,
            color: '#3498db',
            currentPlatform: null,
            fallStartY: 0,
            falling: false
        };

        const gravity = 0.8;
        const friction = 0.8;
        
        let platforms = [];
        let hazards = [];
        let enemies = [];
        let ladders = []; 
        let goal = {};
        let fireBars = []; 
        let clouds = [];

        function createSlide(startX, startY, width, height, steps) {
            let stepW = width / steps;
            let stepH = height / steps;
            for(let i=0; i<steps; i++) {
                platforms.push({
                    x: startX + (i * stepW), y: startY + (i * stepH),
                    w: stepW + 2, h: stepH + 40, 
                    type: 'slide', isStep: true 
                });
            }
            platforms.push({ x: startX, y: startY, w: width, h: height, type: 'slide_visual' });
        }

        function initLevel(level) {
            const w = canvas.width;
            const h = canvas.height;
            const unit = h > 100 ? h / 10 : 60;

            // Reset
            player.vx = 0; player.vy = 0;
            player.climbing = false; player.jumpCount = 0; player.currentPlatform = null;
            hasKey = false; keyItem = null;
            fireBars = []; clouds = [];
            document.getElementById('key-display').style.display = 'none';
            document.getElementById('level-display').innerText = "NIVEAU " + level;
            
            platforms = []; hazards = []; enemies = []; ladders = [];

            // Reset couleurs par d√©faut
            document.body.style.backgroundColor = "#fffdf0";

            if (level === 1) {
                // --- NIVEAU 1 ---
                platforms.push({ x: -100, y: unit * 2, w: 600, h: unit }); 
                player.x = 50; player.y = (unit * 2) - player.h; player.grounded = true;

                if(difficultyMultiplier > 1.2) hazards.push({ x: 300, y: unit * 2 - 25, w: 25, h: 25, type: 'spike' });

                let trapX = 550; let trapY = unit * 3;
                platforms.push({ x: trapX, y: trapY, w: unit * 4, h: unit });
                hazards.push({ x: trapX + 30, y: trapY - 25, w: 25, h: 25, type: 'spike' });
                hazards.push({ x: trapX + 130, y: trapY - 25, w: 25, h: 25, type: 'spike' });
                if(difficultyMultiplier > 1.5) hazards.push({ x: trapX + 80, y: trapY - 25, w: 25, h: 25, type: 'spike' });

                let slideX = trapX + unit * 4;
                createSlide(slideX, unit * 3, unit * 4, unit * 2, 8); 

                let zombiePlatX = slideX + unit * 4;
                let zombiePlatY = unit * 5;
                platforms.push({ x: zombiePlatX, y: zombiePlatY, w: unit * 8, h: unit });
                enemies.push({ x: zombiePlatX + 200, y: zombiePlatY - 60, w: 50, h: 60, type: 'zombie', patrolStart: zombiePlatX + 50, patrolEnd: zombiePlatX + unit * 7, dir: 1, speed: 2 * difficultyMultiplier });

                let ladderX = zombiePlatX + unit * 7;
                let floorY = h - unit * 1.5;
                ladders.push({ x: ladderX, y: zombiePlatY, w: 60, h: floorY - zombiePlatY });

                platforms.push({ x: ladderX - 500, y: floorY, w: w + 1000, h: unit * 2 });
                enemies.push({ x: ladderX - 200, y: floorY - 60, w: 60, h: 60, type: 'chest_monster', patrolStart: ladderX - 350, patrolEnd: ladderX - 100, dir: 1, speed: 2 * difficultyMultiplier });
                if(difficultyMultiplier > 1.2) enemies.push({ x: ladderX + 100, y: floorY - 60, w: 60, h: 60, type: 'chest_monster', patrolStart: ladderX, patrolEnd: ladderX + 300, dir: -1, speed: 2.5 * difficultyMultiplier });

                keyItem = { x: ladderX - 400, y: floorY - 50, w: 40, h: 40 };
                goal = { x: ladderX + 300, y: floorY - 80, w: 70, h: 80 };
                hazards.push({ x: -1000, y: h + 100, w: w * 20, h: 100, type: 'void' });

            } else if (level === 2) {
                // --- NIVEAU 2 ---
                platforms.push({ x: -50, y: unit * 5, w: 200, h: unit });
                player.x = 20; player.y = unit * 5 - player.h; player.grounded = true;

                platforms.push({ x: 150, y: unit * 5, w: 120, h: 20, type: 'moving', vx: 1.5 * difficultyMultiplier, minX: 150, maxX: 400 });

                let midLandX = 450;
                let midLandY = unit * 5;
                platforms.push({ x: midLandX, y: midLandY, w: unit * 6, h: unit });
                enemies.push({ x: midLandX + 200, y: midLandY - 60, w: 60, h: 60, type: 'chest_monster', patrolStart: midLandX, patrolEnd: midLandX + unit * 5, dir: 1, speed: 2 * difficultyMultiplier });

                let liftX = midLandX + unit * 6 + 20;
                platforms.push({ x: liftX, y: midLandY, w: 100, h: 20, type: 'moving', vy: -2 * difficultyMultiplier, minY: unit * 2, maxY: midLandY, vx: 0 });

                let topX = liftX + 120;
                platforms.push({ x: topX, y: unit * 2, w: unit * 4, h: 20 });
                enemies.push({ x: topX + 50, y: unit * 2 - 60, w: 50, h: 60, type: 'zombie', patrolStart: topX, patrolEnd: topX + unit * 3, dir: 1, speed: 2 * difficultyMultiplier });
                if (difficultyMultiplier > 1.2) hazards.push({ x: topX + unit * 3.5, y: unit * 2 - 25, w: 25, h: 25, type: 'spike' });

                keyItem = { x: topX + unit * 3, y: unit * 2 - 50, w: 40, h: 40 };

                let exitY = h - unit;
                platforms.push({ x: midLandX - 200, y: exitY, w: w + 200, h: unit });
                goal = { x: topX + 300, y: exitY - 80, w: 70, h: 80 };
                if(difficultyMultiplier > 1.5) enemies.push({ x: topX + 200, y: exitY - 60, w: 50, h: 60, type: 'zombie', patrolStart: topX + 100, patrolEnd: topX + 300, dir: -1, speed: 3 });

                platforms.push({ x: midLandX - 300, y: exitY, w: 100, h: 20, type: 'moving', vy: -1.5, minY: unit * 5, maxY: exitY, vx: 0 });
                platforms.push({ x: midLandX - 400, y: unit * 5, w: 80, h: 20 });
                platforms.push({ x: topX + unit * 5, y: unit * 4, w: 100, h: 20 });
                platforms.push({ x: topX + unit * 6, y: unit * 6, w: 100, h: 20 });

                hazards.push({ x: -1000, y: h + 50, w: w * 30, h: 100, type: 'void' });

            } else if (level === 3) {
                // --- NIVEAU 3 ---
                document.body.style.backgroundColor = "#2c3e50"; 
                platforms.push({ x: -50, y: unit * 6, w: 200, h: unit });
                player.x = 50; player.y = unit * 6 - player.h; player.grounded = true;

                let isle1 = 250;
                platforms.push({ x: isle1, y: unit * 6, w: 100, h: unit });
                fireBars.push({ cx: isle1 + 50, cy: unit * 6 + 10, length: 120, angle: 0, speed: 0.05 * difficultyMultiplier });

                let isle2 = 450;
                platforms.push({ x: isle2, y: unit * 5, w: 100, h: unit });
                fireBars.push({ cx: isle2 + 50, cy: unit * 5 + 10, length: 130, angle: Math.PI, speed: -0.06 * difficultyMultiplier });

                let isle3 = 650;
                platforms.push({ x: isle3, y: unit * 4, w: 100, h: unit });
                
                let bridgeX = 850;
                platforms.push({ x: bridgeX, y: unit * 4, w: 400, h: unit });
                enemies.push({ x: bridgeX + 200, y: unit * 4 - 80, w: 80, h: 80, type: 'chest_monster', patrolStart: bridgeX, patrolEnd: bridgeX + 300, dir: 1, speed: 3 * difficultyMultiplier });

                goal = { x: bridgeX + 350, y: unit * 4 - 60, w: 40, h: 60, type: 'axe' };
                hazards.push({ x: -1000, y: h - 50, w: w * 30, h: 100, type: 'lava_floor' });

            } else if (level === 4) {
                // --- NIVEAU 4 ---
                document.body.style.backgroundColor = "#5c94fc";
                
                for(let i=0; i<10; i++) {
                    clouds.push({ x: Math.random() * w * 4, y: Math.random() * (h/2), w: 60 + Math.random()*40 });
                }

                let groundY = h - unit;
                platforms.push({ x: -50, y: groundY, w: 400, h: unit, type: 'brick_floor' });
                player.x = 50; player.y = groundY - player.h; player.grounded = true;

                let pipe1X = 450;
                platforms.push({ x: pipe1X, y: groundY - 60, w: 60, h: 60 + unit, type: 'pipe' });
                platforms.push({ x: pipe1X + 150, y: groundY, w: 300, h: unit, type: 'brick_floor' });
                
                enemies.push({ x: pipe1X + 200, y: groundY - 60, w: 50, h: 60, type: 'zombie', patrolStart: pipe1X + 150, patrolEnd: pipe1X + 400, dir: -1, speed: 2 * difficultyMultiplier });

                let pipe2X = pipe1X + 350;
                platforms.push({ x: pipe2X, y: groundY - 90, w: 60, h: 90 + unit, type: 'pipe' });

                let bricksX = pipe2X + 200;
                let bricksY = groundY - 150;
                platforms.push({ x: bricksX, y: bricksY, w: 180, h: 40, type: 'brick_block' });
                platforms.push({ x: bricksX + 250, y: bricksY - 50, w: 40, h: 40, type: 'gold_block' });
                keyItem = { x: bricksX + 255, y: bricksY - 100, w: 30, h: 30 };

                let endGroundX = bricksX + 400;
                platforms.push({ x: endGroundX, y: groundY, w: 600, h: unit, type: 'brick_floor' });

                let stairsX = endGroundX + 100;
                for(let i=0; i<5; i++) {
                    platforms.push({ x: stairsX + (i*40), y: groundY - (i*40) - 40, w: 40, h: 40, type: 'brick_block' });
                }

                goal = { x: stairsX + 350, y: groundY - 120, w: 10, h: 120, type: 'flag' };
                platforms.push({ x: stairsX + 400, y: groundY - 100, w: 100, h: 100, type: 'castle' });

                hazards.push({ x: -1000, y: h + 100, w: w * 20, h: 100, type: 'void' });
            } else if (level === 5) {
                // --- NIVEAU 5 : STYLE MINECRAFT ---
                document.body.style.backgroundColor = "#87CEEB"; // Ciel Minecraft

                // Construction en "chunks" (blocs)
                let blockSize = 40;
                
                // Sol de d√©part (Herbe)
                for(let i=0; i<15; i++) {
                    platforms.push({ x: i*blockSize, y: h - blockSize*2, w: blockSize, h: blockSize, type: 'grass_block' });
                    // Terre dessous
                    platforms.push({ x: i*blockSize, y: h - blockSize, w: blockSize, h: blockSize, type: 'dirt_block' });
                }
                player.x = 50; player.y = h - blockSize*3; player.grounded = true;

                // Arbre
                let treeX = 300;
                // Tronc
                platforms.push({ x: treeX, y: h - blockSize*5, w: blockSize, h: blockSize*3, type: 'wood' });
                // Feuilles
                platforms.push({ x: treeX - blockSize, y: h - blockSize*7, w: blockSize*3, h: blockSize*2, type: 'leaves' });
                platforms.push({ x: treeX, y: h - blockSize*8, w: blockSize, h: blockSize, type: 'leaves' });

                // Trou vers la mine (Pierre)
                let caveX = 650;
                // Plateformes flottantes (Pierre)
                platforms.push({ x: caveX, y: h - blockSize*4, w: blockSize*2, h: blockSize, type: 'stone' });
                platforms.push({ x: caveX + 150, y: h - blockSize*2, w: blockSize*2, h: blockSize, type: 'stone' });

                // Lave en bas
                hazards.push({ x: caveX, y: h - 20, w: 400, h: 20, type: 'lava_floor' });

                // Ile du Nether (Flottante)
                let netherX = caveX + 400;
                platforms.push({ x: netherX, y: h - blockSize*5, w: blockSize*4, h: blockSize, type: 'netherrack' });
                
                // Portail du Nether (Fin)
                goal = { x: netherX + blockSize, y: h - blockSize*5 - 80, w: 60, h: 80, type: 'nether_portal' };

                // Diamant (Cl√©) - Sur l'arbre
                keyItem = { x: treeX, y: h - blockSize*9, w: 30, h: 30, type: 'diamond' };

                // Ennemis (Creeper = Zombie vert mais on changera le dessin si possible, ici Zombie classique)
                enemies.push({ x: netherX + 50, y: h - blockSize*5 - 60, w: 50, h: 60, type: 'zombie', patrolStart: netherX, patrolEnd: netherX + 150, dir: 1, speed: 2 * difficultyMultiplier });

                hazards.push({ x: -1000, y: h + 100, w: w * 30, h: 100, type: 'void' });
            }
        }

        // --- UPDATE ---
        function update() {
            if (!gameRunning) return;
            if (invincibilityTimer > 0) invincibilityTimer--;
            frameTick++; 
            let prevY = player.y;

            for(let e of enemies) {
                if (e.patrolEnd) {
                    e.x += e.dir * (e.speed || 2);
                    if(e.x > e.patrolEnd) { e.x = e.patrolEnd; e.dir = -1; }
                    if(e.x < e.patrolStart) { e.x = e.patrolStart; e.dir = 1; }
                }
            }

            for(let p of platforms) {
                if (p.type === 'moving') {
                    if (p.vx) {
                        p.x += p.vx;
                        if (p.x > p.maxX || p.x < p.minX) p.vx *= -1;
                    }
                    if (p.vy) {
                        p.y += p.vy;
                        if (p.y > p.maxY || p.y < p.minY) p.vy *= -1;
                    }
                    if (player.grounded && player.currentPlatform === p) {
                        player.x += p.vx || 0;
                        player.y += p.vy || 0;
                    }
                }
            }

            if (!hasKey && keyItem) {
                if (player.x < keyItem.x + keyItem.w && player.x + player.w > keyItem.x &&
                    player.y < keyItem.y + keyItem.h && player.y + player.h > keyItem.y) {
                    hasKey = true; keyItem = null;
                    document.getElementById('key-display').style.display = "inline";
                }
            }

            for(let fb of fireBars) fb.angle += fb.speed;

            let touchingLadder = false;
            let currentLadder = null;
            for(let l of ladders) {
                if (player.x + player.w > l.x && player.x < l.x + l.w &&
                    player.y + player.h > l.y - 10 && player.y < l.y + l.h + 20) {
                    touchingLadder = true; currentLadder = l;
                }
            }
            if (touchingLadder && (keys.up || keys.down)) {
                player.climbing = true; player.jumpCount = 0; player.currentPlatform = null;
                player.falling = false; 
            }
            if (!touchingLadder) player.climbing = false;

            if (player.climbing) {
                player.vy = 0; player.vx = 0;
                if(keys.up) player.y -= 4;
                if(keys.down) player.y += 4;
                if(keys.left) player.x -= 2;
                if(keys.right) player.x += 2;
                if (currentLadder && player.y + player.h > currentLadder.y + currentLadder.h) {
                    player.y = (currentLadder.y + currentLadder.h) - player.h;
                }
            } else {
                if (keys.right) player.vx += 1;
                if (keys.left) player.vx -= 1;
                
                player.vx *= friction;
                let maxSpeed = player.baseSpeed * Math.min(difficultyMultiplier, 1.2); 
                if(player.vx > maxSpeed) player.vx = maxSpeed;
                if(player.vx < -maxSpeed) player.vx = -maxSpeed;
                
                player.x += player.vx;
                player.vy += gravity;
                if(player.vy > 15) player.vy = 15; 
                player.y += player.vy;

                if (player.vy > 0 && !player.grounded) {
                    if (!player.falling) {
                        player.falling = true;
                        player.fallStartY = player.y;
                    }
                }
            }

            player.grounded = false;
            let onAnyPlatform = false;

            if (!player.climbing || keys.up) { 
                for (let p of platforms) {
                    if (p.type === 'slide_visual') continue; 
                    if (p.type === 'castle') continue; 

                    if (player.x + player.w > p.x + 5 && player.x < p.x + p.w - 5) {
                        let feetNow = player.y + player.h;
                        let feetBefore = prevY + player.h;
                        let tolerance = (p.type === 'moving' && p.vy < 0) ? 15 - p.vy : 15;

                        if (player.vy >= 0 && feetBefore <= p.y + tolerance && feetNow >= p.y) {
                            
                            if (currentLevel === 2 && player.falling) {
                                let fallDistance = p.y - player.fallStartY;
                                if (fallDistance > 600) { // Tol√©rance encore augment√©e (+5 lignes = 150px)
                                    takeDamage("Chute de trop haut !");
                                }
                            }

                            player.y = p.y - player.h;
                            player.vy = 0;
                            player.grounded = true;
                            player.jumpCount = 0; 
                            player.falling = false;
                            player.currentPlatform = p; 
                            onAnyPlatform = true;
                            if (p.type === 'slide') player.vx += 5; 
                        }
                    }
                }
            }
            if (!onAnyPlatform) player.currentPlatform = null;
            if(player.x < 0) { player.x = 0; player.vx = 0; }
            
            checkInteractions();
        }

        function takeDamage(reason) {
            if (invincibilityTimer > 0) return;
            
            lives--; 
            updateHud();
            if (lives <= 0) gameOver("Oh non ! " + (reason || "Tu n'as plus de vies."));
            else { 
                player.vy = -10; player.vx = -player.vx * 1.5; 
                invincibilityTimer = 60; 
            }
        }

        function updateHud() {
            let hearts = ""; for(let i=0; i<lives; i++) hearts += "‚ù§Ô∏è";
            document.getElementById('hearts').innerText = hearts;
        }

        function checkInteractions() {
            const hit = (a, b) => {
                return a.x < b.x + b.w && a.x + a.w > b.x &&
                       a.y < b.y + b.h && a.y + a.h > b.y;
            };

            if (invincibilityTimer === 0) {
                for(let fb of fireBars) {
                    let endX = fb.cx + Math.cos(fb.angle) * fb.length;
                    let endY = fb.cy + Math.sin(fb.angle) * fb.length;
                    for(let i=0; i<=5; i++) {
                        let px = fb.cx + (endX - fb.cx) * (i/5);
                        let py = fb.cy + (endY - fb.cy) * (i/5);
                        if (px > player.x && px < player.x + player.w &&
                            py > player.y && py < player.y + player.h) {
                            takeDamage("Br√ªl√© !"); break;
                        }
                    }
                }
            }

            if (hit(player, goal)) {
                if (currentLevel === 5 || hasKey) {
                    levelWin();
                } else {
                    if (player.x < goal.x) player.x -= 10;
                    ctx.fillStyle = "black"; ctx.font = "bold 20px 'Patrick Hand'";
                }
                return;
            }

            if (invincibilityTimer === 0) {
                for(let h of hazards) if (hit(player, h)) {
                    if(h.type === 'void' || h.type === 'lava_floor') { 
                        lives--; updateHud();
                        if (lives <= 0) gameOver("Tomb√© !");
                        else { player.x=50; player.y=0; player.vy=0; invincibilityTimer=60; }
                    } else takeDamage("A√Øe !");
                }
                for(let e of enemies) if (hit(player, e)) takeDamage("Monstre !");
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Fond
            if (currentLevel === 3) ctx.fillStyle = "#2c3e50"; 
            else if (currentLevel === 4) ctx.fillStyle = "#5c94fc";
            else if (currentLevel === 5) ctx.fillStyle = "#87CEEB";
            else ctx.fillStyle = "#fffdf0";
            
            ctx.fillRect(0,0,canvas.width, canvas.height);
            
            if (currentLevel < 3) {
                ctx.strokeStyle = "rgba(100, 180, 255, 0.3)"; ctx.lineWidth = 1; ctx.beginPath();
                for(let y=0; y<canvas.height; y+=30) { ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); } ctx.stroke();
                ctx.strokeStyle = "rgba(255, 100, 100, 0.4)"; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(40, 0); ctx.lineTo(40, canvas.height); ctx.stroke();
            }

            let camX = Math.min(0, (canvas.width * 0.3) - player.x);
            ctx.save(); ctx.translate(camX, 0);

            // Nuages (Niveau 4)
            if (currentLevel === 4 || currentLevel === 5) {
                ctx.fillStyle = "rgba(255,255,255,0.8)";
                for(let c of clouds) {
                    ctx.beginPath(); ctx.arc(c.x, c.y, c.w/2, 0, Math.PI*2); ctx.arc(c.x+c.w/2, c.y-10, c.w/2, 0, Math.PI*2); ctx.arc(c.x+c.w, c.y, c.w/2, 0, Math.PI*2); ctx.fill();
                }
            }

            // Barres de feu
            for(let fb of fireBars) {
                ctx.strokeStyle = "orange"; ctx.lineWidth = 5; ctx.beginPath();
                ctx.moveTo(fb.cx, fb.cy);
                ctx.lineTo(fb.cx + Math.cos(fb.angle) * fb.length, fb.cy + Math.sin(fb.angle) * fb.length);
                ctx.stroke();
                ctx.fillStyle = "grey"; ctx.beginPath(); ctx.arc(fb.cx, fb.cy, 10, 0, Math.PI*2); ctx.fill();
            }

            for(let l of ladders) {
                ctx.strokeStyle = "#795548"; ctx.lineWidth = 4; ctx.beginPath();
                ctx.moveTo(l.x, l.y); ctx.lineTo(l.x, l.y+l.h);
                ctx.moveTo(l.x+l.w, l.y); ctx.lineTo(l.x+l.w, l.y+l.h);
                for(let i=0; i<l.h; i+=30) { ctx.moveTo(l.x, l.y+i); ctx.lineTo(l.x+l.w, l.y+i); } ctx.stroke();
            }

            for(let p of platforms) {
                if (p.isStep) continue; 
                
                if(p.type === 'slide_visual') {
                    ctx.fillStyle = "rgba(241, 196, 15, 0.8)"; ctx.beginPath();
                    ctx.moveTo(p.x, p.y); ctx.lineTo(p.x + p.w, p.y + p.h); ctx.lineTo(p.x, p.y + p.h); ctx.fill();
                    ctx.strokeStyle = "orange"; ctx.lineWidth = 5; ctx.beginPath();
                    ctx.moveTo(p.x, p.y); ctx.lineTo(p.x + p.w, p.y + p.h); ctx.stroke();
                } 
                else if (p.type === 'moving') {
                    ctx.fillStyle = "#3498db"; ctx.fillRect(p.x, p.y, p.w, p.h);
                    ctx.strokeStyle = "#2980b9"; ctx.lineWidth = 3; ctx.strokeRect(p.x, p.y, p.w, p.h);
                    ctx.fillStyle = "white"; ctx.fillRect(p.x+5, p.y+5, 5, 5); ctx.fillRect(p.x+p.w-10, p.y+5, 5, 5);
                } 
                else if (p.type === 'pipe') {
                    ctx.fillStyle = "#27ae60"; ctx.fillRect(p.x, p.y, p.w, p.h); 
                    ctx.strokeStyle = "#1e8449"; ctx.lineWidth = 4; ctx.strokeRect(p.x, p.y, p.w, p.h);
                    ctx.fillRect(p.x-5, p.y, p.w+10, 30); 
                    ctx.strokeRect(p.x-5, p.y, p.w+10, 30);
                }
                else if (p.type === 'brick_block') {
                    ctx.fillStyle = "#d35400"; ctx.fillRect(p.x, p.y, p.w, p.h); 
                    ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.strokeRect(p.x, p.y, p.w, p.h);
                    ctx.beginPath(); ctx.moveTo(p.x, p.y+p.h/2); ctx.lineTo(p.x+p.w, p.y+p.h/2); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(p.x+p.w/2, p.y); ctx.lineTo(p.x+p.w/2, p.y+p.h/2); ctx.stroke();
                }
                else if (p.type === 'brick_floor') {
                    ctx.fillStyle = "#c45d16"; ctx.fillRect(p.x, p.y, p.w, p.h); 
                    ctx.fillStyle = "#27ae60"; ctx.fillRect(p.x, p.y, p.w, 10); 
                }
                else if (p.type === 'gold_block') {
                    ctx.fillStyle = "gold"; ctx.fillRect(p.x, p.y, p.w, p.h);
                    ctx.strokeStyle = "black"; ctx.strokeRect(p.x, p.y, p.w, p.h);
                    ctx.fillStyle = "black"; ctx.font = "20px monospace"; ctx.fillText("?", p.x+12, p.y+28);
                }
                else if (p.type === 'castle') {
                    ctx.fillStyle = "#eee"; ctx.fillRect(p.x, p.y, p.w, p.h); 
                    ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(p.x+p.w/2, p.y+p.h, 20, Math.PI, 0); ctx.fill(); 
                    ctx.fillRect(p.x, p.y-20, 20, 20); ctx.fillRect(p.x+p.w-20, p.y-20, 20, 20); 
                }
                // BLOCS MINECRAFT
                else if (p.type === 'grass_block') {
                    ctx.fillStyle = "#8B4513"; ctx.fillRect(p.x, p.y, p.w, p.h);
                    ctx.fillStyle = "#32CD32"; ctx.fillRect(p.x, p.y, p.w, 15);
                    ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.strokeRect(p.x, p.y, p.w, p.h);
                }
                else if (p.type === 'dirt_block') {
                    ctx.fillStyle = "#8B4513"; ctx.fillRect(p.x, p.y, p.w, p.h);
                    ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.strokeRect(p.x, p.y, p.w, p.h);
                }
                else if (p.type === 'stone') {
                    ctx.fillStyle = "#757575"; ctx.fillRect(p.x, p.y, p.w, p.h);
                    ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.strokeRect(p.x, p.y, p.w, p.h);
                }
                else if (p.type === 'wood') {
                    ctx.fillStyle = "#5D4037"; ctx.fillRect(p.x, p.y, p.w, p.h);
                    ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.strokeRect(p.x, p.y, p.w, p.h);
                }
                else if (p.type === 'leaves') {
                    ctx.fillStyle = "#228B22"; ctx.fillRect(p.x, p.y, p.w, p.h);
                    ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.strokeRect(p.x, p.y, p.w, p.h);
                }
                else if (p.type === 'netherrack') {
                    ctx.fillStyle = "#800000"; ctx.fillRect(p.x, p.y, p.w, p.h);
                    ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.strokeRect(p.x, p.y, p.w, p.h);
                }
                else {
                    ctx.fillStyle = currentLevel === 3 ? "#5d4037" : "#2c3e50"; 
                    ctx.fillRect(p.x, p.y, p.w, p.h);
                    ctx.strokeStyle = currentLevel === 3 ? "#8d6e63" : "#27ae60"; 
                    ctx.lineWidth = 4; ctx.beginPath();
                    ctx.moveTo(p.x, p.y); for(let i=0; i<p.w; i+=10) ctx.lineTo(p.x+i+5, p.y - 5); ctx.stroke();
                }
            }

            if (!hasKey && keyItem) {
                if (keyItem.type === 'diamond') {
                    ctx.fillStyle = "#00BFFF";
                    ctx.beginPath();
                    ctx.moveTo(keyItem.x + keyItem.w/2, keyItem.y);
                    ctx.lineTo(keyItem.x + keyItem.w, keyItem.y + keyItem.h/2);
                    ctx.lineTo(keyItem.x + keyItem.w/2, keyItem.y + keyItem.h);
                    ctx.lineTo(keyItem.x, keyItem.y + keyItem.h/2);
                    ctx.fill();
                } else {
                    ctx.fillStyle = "gold"; ctx.beginPath(); ctx.arc(keyItem.x+15, keyItem.y+10, 10, 0, Math.PI*2); ctx.fill();
                    ctx.fillRect(keyItem.x+12, keyItem.y+10, 6, 25); ctx.fillRect(keyItem.x+12, keyItem.y+25, 12, 5); ctx.fillRect(keyItem.x+12, keyItem.y+32, 10, 5);
                    if (Math.floor(Date.now() / 200) % 2 === 0) { ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(keyItem.x+10, keyItem.y+5, 3, 0, Math.PI*2); ctx.fill(); }
                }
            }

            for(let h of hazards) {
                if(h.type === 'spike') {
                    ctx.fillStyle = "#c0392b"; ctx.beginPath(); ctx.moveTo(h.x, h.y+h.h); ctx.lineTo(h.x+h.w/2, h.y); ctx.lineTo(h.x+h.w, h.y+h.h); ctx.fill();
                } else if (h.type === 'lava_floor') {
                    ctx.fillStyle = "#e74c3c"; ctx.fillRect(h.x, h.y, h.w, h.h);
                    if(Math.random() < 0.1) {
                        ctx.fillStyle = "#f1c40f";
                        let bx = h.x + Math.random() * 800; 
                        if(bx > camX && bx < camX + canvas.width) ctx.fillRect(bx, h.y + Math.random()*20, 5, 5);
                    }
                }
            }

            for(let e of enemies) {
                if(e.type === 'zombie') {
                    ctx.fillStyle = "#2ecc71"; ctx.fillRect(e.x, e.y, e.w, e.h);
                    ctx.fillRect(e.x-5, e.y-20, e.w+10, 30);
                    ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(e.x+12, e.y-5, 8, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(e.x+32, e.y-5, 6, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(e.x+12, e.y-5, 2, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(e.x+32, e.y-5, 2, 0, Math.PI*2); ctx.fill();
                    if (Math.floor(frameTick/10)%2 === 0) { ctx.fillStyle = "#27ae60"; ctx.fillRect(e.x+5, e.y+e.h, 10, 10); } 
                    else { ctx.fillStyle = "#27ae60"; ctx.fillRect(e.x+e.w-15, e.y+e.h, 10, 10); }
                    ctx.fillStyle="black"; ctx.font = "bold 20px 'Patrick Hand'"; ctx.fillText("RE RE RE !", e.x, e.y-30);
                } else if(e.type === 'chest_monster') {
                    ctx.fillStyle = "#8d6e63"; ctx.fillRect(e.x, e.y, e.w, e.h);
                    ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.strokeRect(e.x, e.y, e.w, e.h);
                    ctx.fillStyle = "white"; ctx.beginPath(); ctx.moveTo(e.x, e.y+20);
                    for(let i=0; i<e.w; i+=10) { ctx.lineTo(e.x+i+5, e.y+30); ctx.lineTo(e.x+i+10, e.y+20); } ctx.fill();
                    ctx.strokeStyle = "#e74c3c"; ctx.lineWidth = 3; ctx.beginPath();
                    let tx = e.x + e.w + 10, ty = e.y + e.h;
                    ctx.moveTo(tx, ty); ctx.lineTo(tx, ty-50); ctx.moveTo(tx-10, ty-50); ctx.lineTo(tx+10, ty-50);
                    ctx.moveTo(tx-10, ty-50); ctx.lineTo(tx-10, ty-65); ctx.moveTo(tx, ty-50); ctx.lineTo(tx, ty-70);
                    ctx.moveTo(tx+10, ty-50); ctx.lineTo(tx+10, ty-65); ctx.stroke();
                }
            }

            if (goal.type === 'axe') {
                ctx.fillStyle = "gold"; ctx.fillRect(goal.x, goal.y, goal.w, goal.h);
                ctx.strokeStyle = "black"; ctx.strokeRect(goal.x, goal.y, goal.w, goal.h);
                ctx.fillStyle = "black"; ctx.fillText("FIN", goal.x, goal.y - 10);
            } else if (goal.type === 'flag') {
                ctx.fillStyle = "green"; ctx.fillRect(goal.x, goal.y, 5, 120);
                ctx.fillStyle = "gold"; ctx.beginPath(); ctx.arc(goal.x+2, goal.y, 5, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "red"; ctx.beginPath(); ctx.moveTo(goal.x+5, goal.y+10); ctx.lineTo(goal.x+30, goal.y+25); ctx.lineTo(goal.x+5, goal.y+40); ctx.fill();
            } else if (goal.type === 'nether_portal') {
                ctx.fillStyle = "#6a0dad"; ctx.fillRect(goal.x, goal.y, goal.w, goal.h); // Violet
                ctx.strokeStyle = "black"; ctx.lineWidth = 4; ctx.strokeRect(goal.x, goal.y, goal.w, goal.h); // Obsidienne
            } else {
                ctx.fillStyle = "#f1c40f"; ctx.fillRect(goal.x, goal.y, goal.w, goal.h);
                ctx.strokeStyle = "black"; ctx.lineWidth = 3; ctx.strokeRect(goal.x, goal.y, goal.w, goal.h);
                ctx.fillStyle = "black"; 
                let doorText = currentLevel === 5 ? "FIN" : "NIV " + (currentLevel + 1);
                ctx.fillText(doorText, goal.x + 10, goal.y - 10);
                ctx.beginPath(); ctx.arc(goal.x+goal.w-10, goal.y+goal.h/2, 4, 0, Math.PI*2); ctx.fill();
                
                if (!hasKey && currentLevel !== 3 && currentLevel !== 4 && currentLevel !== 5) {
                    ctx.fillStyle = "red"; ctx.fillRect(goal.x + 20, goal.y + 30, 30, 30);
                    ctx.fillStyle = "white"; ctx.font = "30px sans-serif"; ctx.fillText("üîí", goal.x + 20, goal.y + 55);
                    if (Math.abs(player.x - goal.x) < 100) {
                        ctx.fillStyle = "red"; ctx.font = "bold 24px 'Patrick Hand'"; ctx.fillText("IL FAUT LA CL√â !", goal.x - 50, goal.y - 40);
                    }
                }
            }

            if(invincibilityTimer % 10 < 5) {
                ctx.fillStyle = player.color; ctx.beginPath();
                ctx.ellipse(player.x + player.w/2, player.y + player.h/2, player.w/2, player.h/2, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(player.x+10, player.y+15, 6, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(player.x+25, player.y+15, 6, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(player.x+12, player.y+15, 2, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(player.x+27, player.y+15, 2, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(player.x+player.w/2, player.y+30, 8, 0, Math.PI, false); ctx.stroke();
            }
            ctx.restore();
        }

        function nextLevelAction() {
            if (currentLevel < 5) {
                currentLevel++;
                document.getElementById('message-box').style.display = 'none';
                lastTime = 0; accumulator = 0;
                gameRunning = true; levelComplete = false;
                initLevel(currentLevel);
                if (animationId) cancelAnimationFrame(animationId);
                loop(0); 
            } else {
                resetGame();
            }
        }

        function handleKey(e, state) {
            const k = e.key.toLowerCase();
            
            if(['arrowleft', 'q', 'a'].includes(k)) keys.left = state;
            if(['arrowright', 'd', 'z'].includes(k)) keys.right = state;
            if(['arrowup', 'w', ' '].includes(k)) keys.up = state;
            if(['arrowdown', 's'].includes(k)) keys.down = state;
            
            if (state && ['1','2','3','4','5'].includes(e.key)) {
                currentLevel = parseInt(e.key);
                startGame('easy'); 
            }
            if (state && e.key === '+') {
                if (lives < 10) lives++;
                updateHud();
            }

            if(state && keys.up) { 
                if (player.grounded || player.climbing) {
                    player.vy = -player.jumpForce; player.grounded = false; player.climbing = false; player.jumpCount = 1; 
                } else if (player.jumpCount < 2) {
                    player.vy = -player.jumpForce; player.jumpCount++; 
                }
            }
            if (state && e.code === 'Space') {
                let msgBox = document.getElementById('message-box');
                if (msgBox.style.display === 'block') {
                    let btnText = document.getElementById('msg-btn').innerText;
                    if (btnText === "Continuer") nextLevelAction();
                    else resetGame();
                }
            }
        }
        window.addEventListener('keydown', e => { handleKey(e, true); });
        window.addEventListener('keyup', e => handleKey(e, false));

        const bindTouch = (id, k) => {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', e => { e.preventDefault(); keys[k] = true; });
            el.addEventListener('touchend', e => { e.preventDefault(); keys[k] = false; });
            el.addEventListener('mousedown', e => { keys[k] = true; });
            el.addEventListener('mouseup', e => { keys[k] = false; });
        }
        bindTouch('btn-left', 'left'); bindTouch('btn-right', 'right'); bindTouch('btn-up', 'up'); bindTouch('btn-down', 'down');
        document.getElementById('btn-up').addEventListener('touchstart', () => {
             if (player.grounded || player.climbing) { player.vy = -player.jumpForce; player.grounded = false; player.climbing = false; player.jumpCount = 1; }
             else if (player.jumpCount < 2) { player.vy = -player.jumpForce; player.jumpCount++; }
        });

        // --- GAME LOOP ---
        function loop(timestamp) { 
            if(!gameRunning) return;
            if (!lastTime) lastTime = timestamp;
            let deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            if (deltaTime > 100) deltaTime = 100; 
            accumulator += deltaTime;
            while (accumulator >= TIME_STEP) { update(); accumulator -= TIME_STEP; }
            draw(); 
            animationId = requestAnimationFrame(loop); 
        }

        function startGame(difficulty) {
            if(difficulty === 'easy') difficultyMultiplier = 1;
            if(difficulty === 'medium') difficultyMultiplier = 1.3;
            if(difficulty === 'hard') difficultyMultiplier = 1.6;

            document.getElementById('start-screen').style.display = 'none';
            lives = 3; updateHud(); 
            if(![1,2,3,4,5].includes(currentLevel)) currentLevel = 1;
            
            lastTime = 0; accumulator = 0;
            gameRunning = true; initLevel(currentLevel); 
            if (animationId) cancelAnimationFrame(animationId);
            loop(0);
        }

        function gameOver(msg) {
            gameRunning = false;
            document.getElementById('msg-title').innerText = "Oh non !";
            document.getElementById('msg-title').style.color = "red";
            document.getElementById('msg-text').innerText = msg;
            document.getElementById('msg-btn').innerText = "Recommencer";
            document.getElementById('msg-hint').innerText = "(ESPACE pour rejouer)";
            document.getElementById('message-box').style.display = "block";
        }

        function levelWin() {
            gameRunning = false;
            levelComplete = true;
            if (currentLevel < 5) {
                document.getElementById('msg-title').innerText = "NIVEAU " + currentLevel + " R√âUSSI !";
                document.getElementById('msg-title').style.color = "green";
                document.getElementById('msg-text').innerText = "Pr√™t pour la suite ?";
                document.getElementById('msg-btn').innerText = "Continuer";
                document.getElementById('msg-hint').innerText = "(ESPACE pour continuer)";
            } else {
                document.getElementById('msg-title').innerText = "JEU TERMIN√â !";
                document.getElementById('msg-title').style.color = "gold";
                document.getElementById('msg-text').innerText = "Tu es le champion !";
                document.getElementById('msg-btn').innerText = "Rejouer";
                document.getElementById('msg-hint').innerText = "(ESPACE pour rejouer)";
            }
            document.getElementById('message-box').style.display = "block";
        }

        function resetGame() {
            document.getElementById('message-box').style.display = "none";
            currentLevel = 1;
            document.getElementById('start-screen').style.display = 'flex'; // Retour √©cran titre
        }

    </script>
</body>
</html>